const {
  getFindings,
  getCountBySeverity,
  getCountByStatus,
  getCountByProject,
  getCountByOrigin,
  getFindingsCountByDate,
  getOverdueFindings,
} = require("../queries/findings.queries");

const PDFDocument = require("pdfkit");
const puppeteer = require("puppeteer");
const path = require("path");

exports.getDashboard = async (req, res, next) => {
  try {
    const severityCounts = await getCountBySeverity();
    const statusCounts = await getCountByStatus();
    const sortedStatusData = sortStatusData(statusCounts);
    const sortedData = sortSeverityData(severityCounts);
    const findingsByProject = await getCountByProject();
    const findingsByOrigin = await getCountByOrigin();
    const findingsByDate7 = await getFindingsCountByDate(7);
    const findingsByDate30 = await getFindingsCountByDate(30);
    const allFindings = await getFindings();
    const numberOfFindings = allFindings.length;
    const numberOfOpenFindings = allFindings.filter(
      (finding) => finding.status === "In Remediation"
    ).length;
    const numberOfClosedFindings = allFindings.filter(
      (finding) => finding.status != "In Remediation"
    ).length;
    const numberOfFindingsOverdue = (await getOverdueFindings()).length;

    res.render("dashboard/dashboard", {
      sortedData,
      sortedStatusData,
      findingsByProject,
      findingsByOrigin,
      findingsByDate7,
      findingsByDate30,
      numberOfFindings,
      numberOfOpenFindings,
      numberOfClosedFindings,
      numberOfFindingsOverdue,
      isAuthenticated: req.isAuthenticated(),
      is2FAVerified: req.session.is2FAVerified,
      currentUser: req.user,
      user: req.user,
    });
  } catch (error) {
    next(error);
  }
};

function sortSeverityData(data) {
  const order = ["Critical", "High", "Medium", "Low", "Info"];
  const sorted = order.map((severity) => {
    const item = data.find((d) => d._id === severity) || { count: 0 };
    return item.count;
  });
  return sorted;
}

function sortStatusData(data) {
  const order = ["In Remediation", "Remediated", "Declined", "Accepted"];
  const sorted = order.map((status) => {
    const item = data.find((d) => d._id === status) || { count: 0 };
    return item.count;
  });
  return sorted;
}

exports.generateOverdueFindingsReport = async (req, res) => {
  try {
    const overdueFindings = await getOverdueFindings(); // Replace with your actual method to get findings

    const browser = await puppeteer.launch();
    const page = await browser.newPage();

    // Set the content of the page
    await page.setContent(`
            <html>
                <head>
                    <style>
                        /* Add your CSS styles here */
                        body {
                            font-family: Arial, sans-serif;
                        }
                        .report-title {
                            text-align: center;
                            font-size: 24px;
                            margin-top: 20px;
                        }
                        .user-info {
                            text-align: center;
                            font-size: 16px;
                            margin-top: 5px;
                        }
                        table {
                            width: 100%;
                            border-collapse: collapse;
                        }
                        th, td {
                            border: 1px solid black;
                            padding: 5px;
                            text-align: left;
                        }
                        th {
                            background-color: lightblue;
                            font-weight: bold;
                        }
                        ul {
                            list-style-type: none;
                            padding: 0;
                        }
                        ul li {
                            margin-bottom: 5px;
                        }
                        footer {
                          width: 100%;
                          display: flex;
                          flex-direction: row wrap;
                          justify-content: space-between;
                          background-color: #d0d0d0;
                          border-top: 20px solid #0092c2;
                          font-size: 12px;
                        }
                        footer>div {
                          display: flex;
                          flex-direction: column;
                        }

                        footer>div>span {
                          text-align: center;
                          font-size: 12px;
                        }
                    </style>
                </head>
                <body>
                    <div class="report-title">Overdue Findings Report</div>
                    <div class="user-info">Generated by: ${
                      req.user.username
                    } on ${new Date().toLocaleDateString()}</div>
                    <div id="content"></div>
                </body>
            </html>
        `);

    // Populate the content with findings
    await page.evaluate((findings) => {
      const contentDiv = document.getElementById("content");
      findings.forEach((finding) => {
        const findingDiv = document.createElement("div");
        findingDiv.innerHTML = `
                    <table>
                        <tr>
                            <th>Reference</th>
                            <th>Title</th>
                            <th>Severity</th>
                            <th>Due Date</th>
                        </tr>
                        <tr>
                            <td width="20%">${finding.reference}</td>
                            <td width="50%">${finding.title}</td>
                            <td width="15%">${finding.severity}</td>
                            <td width="15%">${new Date(
                              finding.dueDate
                            ).toLocaleDateString()}</td>
                        </tr>
                    </table>
                    <ul>
                        <li><b>Type:</b> ${finding.type}</li>
                        <li><b>Origin:</b> ${finding.origin}</li>
                        <li><b>Reported by:</b> ${finding.reportedBy}</li>
                        <li><b>Assignee:</b> ${finding.assignee}</li>
                        <li><b>Description:</b> ${
                          finding.description
                        }</li>                        
                        <li><b>CVE:</b> ${finding.cve}</li>
                        <li><b>CVSS:</b> ${finding.cvss}</li>
                    </ul>
                    <br />
                    <hr />
                    <br />
                `;
        contentDiv.appendChild(findingDiv);
      });
    }, overdueFindings);

    // Generate PDF with footer
    const pdfBuffer = await page.pdf({
      format: "A4",
      printBackground: true,
      margin: {
        top: "20mm",
        bottom: "30mm",
        left: "20mm",
        right: "20mm",
      },
      displayHeaderFooter: true,
      footerTemplate: `
                <footer>
                  <div>
                    <span>Confidential - Internal Use Only</span>
                    <span>Page <span class="pageNumber"></span> of <span class="totalPages"></span></span>
                  </div>
                </footer>
            `,
    });

    await browser.close();

    res.setHeader("Content-Type", "application/pdf");
    res.setHeader(
      "Content-Disposition",
      "attachment; filename=overdue_findings_report.pdf"
    );
    res.send(pdfBuffer);
  } catch (error) {
    res.status(500).send("Error generating report");
  }
};
